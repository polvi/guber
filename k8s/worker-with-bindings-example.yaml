apiVersion: cf.guber.proc.io/v1
kind: Worker
metadata:
  name: example-worker-with-bindings
spec:
  name: example-worker-with-bindings
  script: |
    export default {
      async fetch(request, env, ctx) {
        try {
          let dbResult = "No DB binding";
          let queueResult = "No Queue binding";
          
          // Check if D1 database binding exists
          if (env.MY_DB) {
            try {
              const result = await env.MY_DB.prepare("SELECT 1 as test").first();
              dbResult = `Database test: ${result.test}`;
            } catch (error) {
              dbResult = `Database error: ${error.message}`;
            }
          }
          
          // Check if Queue binding exists
          if (env.MY_QUEUE) {
            try {
              await env.MY_QUEUE.send({ message: "Hello from worker!" });
              queueResult = "Queue message sent!";
            } catch (error) {
              queueResult = `Queue error: ${error.message}`;
            }
          }
          
          return new Response(`${dbResult}, ${queueResult}`, {
            headers: { 'Content-Type': 'text/plain' }
          });
        } catch (error) {
          return new Response(`Worker error: ${error.message}`, {
            status: 500,
            headers: { 'Content-Type': 'text/plain' }
          });
        }
      }
    };
  compatibility_date: "2025-11-27"
  bindings:
    d1_databases:
      - binding: MY_DB
        database_name: example-db
    queues:
      - binding: MY_QUEUE
        queue_name: example-queue
---
apiVersion: cf.guber.proc.io/v1
kind: D1
metadata:
  name: example-db
spec:
  name: example-db
  location: western-us
---
apiVersion: cf.guber.proc.io/v1
kind: Queue
metadata:
  name: example-queue
spec:
  name: example-queue
  settings:
    delivery_delay: 0
    message_retries: 3
    visibility_timeout: 30
